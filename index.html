<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>HitPoints Mini App</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#121212;
            --card:#1e1e1e;
            --muted:#9a9a9a;
            --accent: #10B981; /* premium green */
            --accent-glow: rgba(16,185,129,0.08);
            --accent-soft: rgba(16,185,129,0.04);
            --accent-ring: rgba(16,185,129,0.06);
            --text:#e0e0e0;
            --tab-active-light: rgba(255,255,255,0.035);
        }
        *{box-sizing:border-box}
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        /* TOP */
        .top-area { display:flex; flex-direction:column; gap:12px; margin-bottom:12px; }
        .title-row { display:flex; align-items:center; justify-content:flex-start; }
        .app-title { font-size:20px; font-weight:700; color:var(--text); padding-left:4px; }

        .address-row { display:flex; align-items:center; gap:12px; }
        .address-card {
            background: var(--card);
            border-radius: 14px;
            padding: 12px 14px;
            display:flex; align-items:center; gap:12px; flex:1; min-width:0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.02);
            cursor:pointer;
        }
        .addr-square { width:14px; height:14px; border-radius:3px; background: rgba(255,255,255,0.06); flex:0 0 14px; }
        .addr-square.selected { background:var(--accent); box-shadow:0 0 0 4px var(--accent-ring); }
        .addr-texts { display:flex; flex-direction:column; gap:4px; overflow:hidden; }
        .addr-line { font-weight:600; font-size:14px; color:var(--text); white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
        .addr-sub { font-size:12px; color:var(--muted); }

        .add-address-btn {
            background: var(--accent);
            color: #06140b;
            width:46px; height:46px; border-radius:12px; border:none; font-size:28px; font-weight:700;
            display:inline-flex; align-items:center; justify-content:center; cursor:pointer; flex:0 0 46px;
            box-shadow: 0 6px 18px var(--accent-glow);
        }

        /* TABS: single-line, hide scrollbar */
        .tabs {
            display:flex;
            gap:10px;
            margin-top:8px;
            overflow-x:auto;
            -webkit-overflow-scrolling: touch;
            white-space:nowrap;
            padding-bottom:2px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }
        .tabs::-webkit-scrollbar { display: none; height: 0; } /* Chrome, Safari, Edge */

        .tab {
            display:inline-flex;
            align-items:center;
            justify-content:center;
            flex:0 0 auto;
            background: var(--bg);           /* такой же, как фон */
            color: var(--muted);             /* приглушённый текст в неактивном состоянии */
            padding:8px 14px;
            border-radius: 20px;
            cursor:pointer;
            font-weight:600;
            transition: background 160ms ease, color 160ms ease, transform 120ms ease;
            white-space:nowrap;
            border: 1px solid rgba(255,255,255,0.01);
        }
        .tab:hover { transform: translateY(-2px); }
        .tab.active {
            background: var(--tab-active-light); /* чуть светлее фона */
            color: var(--text);
            border-color: rgba(255,255,255,0.03);
        }

        /* CATEGORIES: уменьшил отступ между разделами */
        .category {
            margin-bottom: 16px; /* уменьшено (было 30px) */
            display: block;
            scroll-margin-top: 84px;
        }
        .category h2 {
            color: var(--accent);
            font-weight: 700;
            font-size: 24px; /* чуть меньше заголовок, чтобы короче */
            margin: 0 0 12px 0; /* уменьшен нижний отступ */
        }

        /* ITEMS: кнопки на одном уровне */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px; /* чуть меньше расстояние между карточками */
        }
        .item {
            background: transparent;
            padding: 8px;
            display: flex;
            flex-direction: column;
            min-height: 260px; /* фиксированная минимальная высота карточки, чтобы кнопки выравнивались */
            border-radius: 10px;
        }
        .item img {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            background: #fff;
            border-radius: 10px;
            margin-bottom: 10px;
            flex: 0 0 auto;
        }
        .item h3 {
            margin: 0 0 10px 0;
            color: #e0e0e0;
            font-weight: 600;
            font-size: 16px;
            line-height: 1.2;
            max-height: 3.6em; /* примерно 3 строки */
            overflow: hidden;
        }
        .price-btn {
            background: var(--card);
            color: var(--text);
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 12px;
            width: 100%;
            margin-top: auto; /* ключевое — отталкивает кнопку вниз карточки */
            align-self: stretch;
            transition: background 0.18s;
        }
        .price-btn:hover { background: #252525; }

        /* BOTTOM SHEET */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; z-index: 1000; -webkit-tap-highlight-color: transparent; }
        #overlay.open { display: block; }
        #details {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0 auto;
            width: 100%;
            max-width: 980px;
            background: #1e1e1e;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -8px 30px rgba(0,0,0,0.6);
            transform: translateY(100%);
            transition: transform 320ms cubic-bezier(.2,.8,.2,1);
            max-height: 85vh;
            overflow: auto;
            padding: 18px;
        }
        #overlay.open #details { transform: translateY(0); }

        .sheet-handle { width:44px; height:4px; background:rgba(255,255,255,0.06); border-radius:4px; margin:6px auto 14px; }
        #close-btn { position:absolute; top:10px; right:12px; background:transparent; color:var(--text); border:none; font-size:24px; cursor:pointer; }
        #detail-image { width:100%; border-radius:10px; margin-bottom:16px; }
        #detail-name { color:var(--text); font-weight:700; font-size:22px; margin-bottom:8px; }
        #detail-desc { color:var(--muted); font-size:15px; margin:10px 0 14px 0; }
        #detail-nutrition h4, #detail-additives h4 { color: var(--accent); }

        .nutrition-grid { display:flex; gap:10px; flex-wrap:nowrap; }
        .nutri-box { width:90px; min-height:70px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:10px; padding:8px; display:flex; flex-direction:column; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.04); }
        .nutri-value{ font-weight:700; font-size:16px; color:var(--text); }
        .nutri-label{ font-size:11px; color:var(--muted); margin-top:4px; text-transform:uppercase; letter-spacing:0.5px; }

        .additive { display:flex; justify-content:space-between; align-items:center; background:#252525; border-radius:10px; padding:10px; margin-bottom:10px; }
        .additive label { color:var(--text); flex:1; }
        #detail-price { color:var(--accent); font-weight:700; font-size:18px; margin:10px 0; }
        .counter { display:flex; justify-content:center; align-items:center; margin-top:10px; }
        .minus, .plus { background:#444; color:#fff; border:none; width:40px; height:40px; border-radius:8px; font-size:22px; cursor:pointer; margin:0 10px; }
        .qty { font-size:20px; min-width:28px; text-align:center; color:#fff; }

        /* Modal address styles */
        .address-modal { display: none; position: fixed; inset: 0; z-index: 1100; }
        .address-modal.active { display: block; }
        .modal-overlay { position:absolute; inset:0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { position:relative; background:#1b1b1b; color:#fff; width:90%; max-width:420px; margin:10vh auto; border-radius:20px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.5); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .modal-title { font-size:18px; font-weight:700; }
        .modal-close { background:transparent; color:#aaa; font-size:24px; border:none; cursor:pointer; }
        .modal-body { display:flex; flex-direction:column; gap:12px; }
        #address-list { display:flex; flex-direction:column; gap:8px; max-height:36vh; overflow:auto; padding-right:6px; }
        .address-item { display:flex; align-items:center; justify-content:space-between; background:#222; padding:10px 14px; border-radius:12px; cursor:pointer; transition:0.12s; }
        .address-item:hover { background:#2a2a2a; }
        .address-item.selected { border:1px solid var(--accent); }
        .modal-divider { height:1px; background: rgba(255,255,255,0.06); margin:8px 0; }
        .modal-add { display:flex; gap:10px; }
        .modal-add input { flex:1; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#111; color:#fff; padding:10px; font-size:14px; }
        .modal-add button { background:var(--accent); color:#06140b; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }

        /* CART BUTTON (floating) */
        #cart-btn {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 1200;
            background: linear-gradient(180deg, var(--accent), #0ea86f);
            color: #05130c;
            padding: 12px 14px;
            border-radius: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(16,185,129,0.14);
            border: none;
            cursor: pointer;
            min-width: 120px;
            justify-content: center;
        }
        #cart-btn .icon { font-size: 18px; }
        #cart-sum { font-size: 16px; }

        /* responsive */
        @media (max-width: 520px) {
            body { padding: 12px; }
            .app-title { font-size: 18px; }
            .items-grid { grid-template-columns: 1fr 1fr; gap:10px; }
            .item { min-height: 220px; padding:6px; }
            .nutri-box { width:78px; min-width:78px; min-height:62px; padding:6px; }
            #details { padding: 14px; border-radius: 12px 12px 0 0; }
            .modal-content { width: 95%; margin:6vh auto; padding:14px; }
            #address-list { max-height: 30vh; }
            #cart-btn { right: 12px; bottom: 12px; padding: 10px 12px; min-width: 110px; }
        }
    </style>
</head>
<body>

    <!-- TITLE -->
    <div class="top-area">
        <div class="title-row">
            <div class="app-title">HitPoints</div>
        </div>

        <!-- address + plus on same line -->
        <div class="address-row">
            <div id="main-address" class="address-card" role="button" title="Открыть адреса">
                <div id="addr-indicator" class="addr-square" aria-hidden="true"></div>
                <div class="addr-texts">
                    <div class="addr-line" id="addr-line">Каменноостровский проспект, 40</div>
                    <div class="addr-sub" id="addr-sub">Санкт-Петербург, Россия</div>
                </div>
                <div class="addr-action" style="color:var(--muted); font-size:18px;">›</div>
            </div>
            <button id="add-address-top" class="add-address-btn" title="Добавить адрес">+</button>
        </div>

        <div class="tabs" id="tabs" role="tablist" aria-label="Категории"></div>
    </div>

    <!-- ADDRESS MODAL -->
    <div id="address-modal" class="address-modal" aria-hidden="true">
      <div class="modal-overlay" data-role="overlay"></div>
      <div class="modal-content" role="dialog" aria-modal="true" aria-label="Менеджер адресов">
        <div class="modal-header">
          <div class="modal-title">Адрес доставки</div>
          <button class="modal-close" aria-label="Закрыть модал">×</button>
        </div>
        <div class="modal-body">
          <div id="address-list"></div>
          <div class="modal-divider"></div>
          <div class="modal-add">
            <input id="new-address" type="text" placeholder="Введите новый адрес...">
            <button id="save-address">Добавить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MENU -->
    <div id="menu"></div>

    <!-- BOTTOM SHEET OVERLAY -->
    <div id="overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div id="details">
            <div class="sheet-handle" aria-hidden="true"></div>
            <button id="close-btn" aria-label="Закрыть">&times;</button>

            <img id="detail-image" src="" alt="">
            <h3 id="detail-name"></h3>
            <p id="detail-desc"></p>

            <!-- nutrition -->
            <div id="detail-nutrition">
                <h4>Пищевая ценность</h4>
                <div class="nutrition-grid">
                    <div class="nutri-box">
                        <div class="nutri-value" id="detail-calories">0 ккал</div>
                        <div class="nutri-label">Калории</div>
                    </div>
                    <div class="nutri-box">
                        <div class="nutri-value" id="detail-proteins">0 г</div>
                        <div class="nutri-label">Белки</div>
                    </div>
                    <div class="nutri-box">
                        <div class="nutri-value" id="detail-fats">0 г</div>
                        <div class="nutri-label">Жиры</div>
                    </div>
                    <div class="nutri-box">
                        <div class="nutri-value" id="detail-carbs">0 г</div>
                        <div class="nutri-label">Углеводы</div>
                    </div>
                </div>
            </div>

            <div id="detail-additives"><h4>Добавки</h4></div>
            <p id="detail-price"></p>

            <div class="counter" id="detail-counter">
                <button class="minus" aria-label="Уменьшить">-</button>
                <span class="qty">0</span>
                <button class="plus" aria-label="Увеличить">+</button>
            </div>
        </div>
    </div>

    <!-- CART BUTTON -->
    <button id="cart-btn" aria-label="Открыть корзину" title="Открыть корзину">
        <span class="icon">🛒</span>
        <span id="cart-sum">0 р</span>
    </button>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        /* === DATA === */
        const menuData = {
            'ШАУРМА': [
                {name: 'Шаурма классическая', price: 300, desc: 'Курица, капуста, томаты, огурцы, морковь по-корейски, лук, фирменный соус, зелень.', calories: 550, proteins: 25, fats: 30, carbs: 45, image: 'https://thumbs.dreamstime.com/b/close-up-grilled-chicken-shawarma-wrap-vegetables-white-sauce-placed-rustic-wooden-board-warm-lighting-386359191.jpg'},
                {name: 'Шаурма фри', price: 360, desc: 'Курица, капуста, картофель фри, томаты, огурцы, морковь по-корейски, лук, фирменный соус, зелень.', calories: 650, proteins: 28, fats: 35, carbs: 55, image: 'https://www.shutterstock.com/image-photo/meat-beef-shawarma-arabic-meal-260nw-2471431623.jpg'},
                {name: 'Шаурма XXL', price: 430, desc: 'Курица, капуста, картофель фри, сыр моцарелла, морковь по-корейски, томаты, огурцы, лук, фирменный соус, зелень.', calories: 800, proteins: 35, fats: 40, carbs: 65, image: 'https://thumbs.dreamstime.com/b/shawarma-meat-vegetables-lies-wooden-table-background-shawarma-meat-vegetables-lies-wooden-table-162488416.jpg'},
            ],
            'БУРГЕРЫ': [
                {name: 'Чизбургер', price: 380, desc: 'Говяжья котлета, лист салата, сыр, маринованные огурчики, помидоры, фирменный соус.', calories: 700, proteins: 30, fats: 40, carbs: 50, image: 'https://external-preview.redd.it/X4Aa9z5flSaXtbq2NXn4uLGzK9Y2AhbvCmRr6tl30Q8.jpg?auto=webp&s=cb671afc9c2654af44304aa5e67a42a81a1e9b3c'},
                {name: 'Чикенбургер', price: 300, desc: 'Куриная котлета, лист салата, сыр, маринованные огурчики, помидоры, фирменный соус.', calories: 600, proteins: 28, fats: 35, carbs: 45, image: 'https://media.istockphoto.com/id/1273265655/photo/burger-with-fried-chicken-meat-isolated-on-white-background.jpg?s=612x612&w=0&k=20&c=iwDZMUYie0zldQBJY6vXjidTqw6rNKrSEnSPszXpJCI='},
            ],
            'ПЕРЕКУС / ФРИ': [
                {name: 'Хот-дог', price: 150, desc: '(булочка, говяжья сосиска, морковь по-корейски, соус)', calories: 400, proteins: 15, fats: 20, carbs: 35, image: 'https://www.mashed.com/img/gallery/these-12-hot-dogs-use-only-the-best-high-quality-ingredients/l-intro-1710886406.jpg'},
                {name: 'Mix-box', price: 350, desc: '(курица, картофель фри, маринованные огурчики, сыр моцарелла, соус)', calories: 750, proteins: 30, fats: 40, carbs: 60, image: 'https://lookaside.fbsbx.com/lookaside/crawler/media/?media_id=10172692477035492'},
                {name: 'Картофель фри', price: 150, desc: '', calories: 300, proteins: 5, fats: 15, carbs: 40, image: 'https://media.gettyimages.com/id/614420426/photo/basket-of-french-fries.jpg?s=612x612&w=gi&k=20&c=0xqKNm7b0f94TKAwR-99vkohcHkAppuXBVbLKNArY3A='},
                {name: 'Картофель по-деревенски', price: 150, desc: '', calories: 320, proteins: 6, fats: 16, carbs: 42, image: 'https://www.gonnawantseconds.com/wp-content/uploads/2022/11/Country-Potatoes-5.jpg'},
                {name: 'Наггетсы', price: 150, desc: '', calories: 280, proteins: 14, fats: 18, carbs: 20, image: 'https://t4.ftcdn.net/jpg/02/59/52/75/360_F_259527589_ZMn1jWZzZ8JZyPP9w2drkjnjFhL0nY9C.jpg'},
                {name: 'Соус (порция)', price: 40, desc: '', calories: 100, proteins: 1, fats: 10, carbs: 5, image: 'https://img.freepik.com/free-photo/red-hot-chilli-sauce-tomato-ketchup-chilli-sauce-puree-with-chili-pepper-tomatoes-garlic-wooden-cutting-board-stone-surface-top-view_1150-44905.jpg?semt=ais_hybrid&w=740&q=80'},
            ],
            'ГОРЯЧИЕ НАПИТКИ': [
                {name: 'Чай (пак.)', price: 30, desc: '', calories: 0, proteins: 0, fats: 0, carbs: 0, image: 'https://img.freepik.com/free-photo/overturned-bowl-full-tea-leaves-spoon-cup-tea-tea-bags-board-marble_114579-58289.jpg?semt=ais_hybrid&w=740&q=80'},
                {name: 'Кофе (молотый в раст.)', price: 60, desc: '', calories: 5, proteins: 0, fats: 0, carbs: 1, image: 'https://img.freepik.com/free-photo/tool-used-coffee-press-cup_23-2149878088.jpg?semt=ais_hybrid&w=740&q=80'},
                {name: 'Какао', price: 120, desc: '', calories: 200, proteins: 5, fats: 10, carbs: 25, image: 'https://img.freepik.com/free-photo/high-angle-decoration-with-mug-hot-chocolate_23-2148312050.jpg?semt=ais_hybrid&w=740&q=80'},
                {name: 'Сливки (порц.)', price: 20, desc: '', calories: 100, proteins: 1, fats: 10, carbs: 2, image: 'https://img.freepik.com/premium-vector/portion-whipped-cream-sour-cream-twisted-into-spiral-butter-wooden-bowl_1278344-10566.jpg?semt=ais_hybrid&w=740'},
            ],
            'ХОЛОДНЫЕ НАПИТКИ': [
                {name: 'Компот', price: 80, desc: '', calories: 150, proteins: 0, fats: 0, carbs: 40, image: 'https://media.istockphoto.com/id/1668740688/photo/plum-compote-in-glass-saucepan-close-up-wooden-spoon.jpg?s=612x612&w=0&k=20&c=8rtFMUAgRDOi55gtyBi6Ga3He04bI4QQLAefadQxRg4='},
                {name: 'Молочный коктейль (молоко, мороженое, сироп)', price: 250, desc: '', calories: 400, proteins: 8, fats: 15, carbs: 60, image: 'https://thumbs.dreamstime.com/b/chocolate-milkshake-tall-glass-dollop-whipped-cream-syrup-cherry-top-high-quality-photo-378834287.jpg'},
                {name: 'Сок', price: 60, desc: '', calories: 100, proteins: 1, fats: 0, carbs: 25, image: 'https://www.shutterstock.com/image-photo/delicious-array-fresh-fruit-juices-260nw-192709250.jpg'},
            ],
        };

        const additives = {
            'korean_carrot': {name: 'Морковь по-корейски', price: 20},
            'jalapeno': {name: 'Халапеньо', price: 20},
            'cheese': {name: 'Сыр', price: 50},
            'pickles': {name: 'Огурчики', price: 30},
            'beef_patty': {name: 'Котлета говяжья', price: 150},
            'chicken_patty': {name: 'Котлета куриная', price: 100},
            'spicy_sauce': {name: 'Соус (острый)', price: 20},
        };

        let cart = {};
        let selectedAdditives = {};
        let categories = Object.keys(menuData);
        let currentKey = '';

        /* Render tabs and menu */
        function renderTabs() {
            const tabsDiv = document.getElementById('tabs');
            tabsDiv.innerHTML = '';
            categories.forEach((cat, index) => {
                let tab = document.createElement('div');
                tab.className = 'tab' + (index === 0 ? ' active' : '');
                tab.textContent = cat;
                tab.setAttribute('data-target', `cat-${cat.toLowerCase().replace(/ /g, '-')}`);
                tab.onclick = () => showCategory(cat);
                tabsDiv.appendChild(tab);
            });
        }

        function showCategory(selectedCat) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent === selectedCat) tab.classList.add('active');
            });
            const activeTab = Array.from(document.querySelectorAll('.tab')).find(t => t.classList.contains('active'));
            if (activeTab) activeTab.scrollIntoView({behavior: 'smooth', inline: 'center'});
            const id = `cat-${selectedCat.toLowerCase().replace(/ /g, '-')}`;
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({behavior: 'smooth', block: 'start'});
        }

        function renderMenu() {
            const menuDiv = document.getElementById('menu');
            menuDiv.innerHTML = '';
            for (let category in menuData) {
                let catDiv = document.createElement('div');
                catDiv.className = 'category';
                catDiv.id = `cat-${category.toLowerCase().replace(/ /g, '-')}`;
                catDiv.innerHTML = `<h2>${category}</h2>`;
                let gridDiv = document.createElement('div');
                gridDiv.className = 'items-grid';
                menuData[category].forEach((item, index) => {
                    let key = `${category}:${index}`;
                    let itemDiv = document.createElement('div');
                    itemDiv.className = 'item';
                    itemDiv.setAttribute('data-name', item.name.toLowerCase());
                    itemDiv.innerHTML = `
                        <img src="${item.image}" alt="${item.name}">
                        <h3>${item.name}</h3>
                        <button class="price-btn" onclick="showDetails('${key}')">${item.price} р</button>
                    `;
                    gridDiv.appendChild(itemDiv);
                });
                catDiv.appendChild(gridDiv);
                menuDiv.appendChild(catDiv);
            }
            // ensure first tab active
            const firstTab = document.querySelector('.tab');
            if (firstTab) firstTab.classList.add('active');
        }

        /* Bottom sheet */
        const sheetOverlay = document.getElementById('overlay');
        const details = document.getElementById('details');

        function showDetails(itemKey) {
            selectedAdditives = {};
            currentKey = itemKey;
            let [cat, idx] = itemKey.split(':');
            let item = menuData[cat][parseInt(idx)];
            document.getElementById('detail-image').src = item.image;
            document.getElementById('detail-image').alt = item.name;
            document.getElementById('detail-name').textContent = item.name;
            document.getElementById('detail-desc').textContent = item.desc;

            document.getElementById('detail-calories').textContent = `${item.calories} ккал`;
            document.getElementById('detail-proteins').textContent = `${item.proteins} г`;
            document.getElementById('detail-fats').textContent = `${item.fats} г`;
            document.getElementById('detail-carbs').textContent = `${item.carbs} г`;

            document.getElementById('detail-price').textContent = `${item.price} р`;
            document.getElementById('detail-counter').setAttribute('data-key', itemKey);
            renderAdditives();
            updateItemUI(itemKey);

            sheetOverlay.classList.add('open');
            sheetOverlay.setAttribute('aria-hidden', 'false');
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
        }

        function hideDetails() {
            sheetOverlay.classList.remove('open');
            sheetOverlay.setAttribute('aria-hidden', 'true');
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
        }

        function renderAdditives() {
            const additivesDiv = document.getElementById('detail-additives');
            additivesDiv.innerHTML = '<h4>Добавки</h4>';
            for (let key in additives) {
                let additive = additives[key];
                let div = document.createElement('div');
                div.className = 'additive';
                div.innerHTML = `
                    <label><input type="checkbox" onchange="toggleAdditive('${key}', this.checked)"> ${additive.name}</label>
                    <span>+${additive.price} р</span>
                `;
                additivesDiv.appendChild(div);
            }
        }

        function toggleAdditive(key, checked) {
            if (checked) selectedAdditives[key] = 1;
            else delete selectedAdditives[key];
            updatePrice();
        }

        function updatePrice() {
            if (!currentKey) return;
            let [cat, idx] = currentKey.split(':');
            let item = menuData[cat][parseInt(idx)];
            let total = item.price;
            for (let key in selectedAdditives) total += additives[key].price * selectedAdditives[key];
            document.getElementById('detail-price').textContent = `${total} р`;
        }

        function changeQuantity(itemKey, delta) {
            if (!cart[itemKey]) cart[itemKey] = {quantity:0, additives:{}};
            cart[itemKey].quantity = Math.max(0, cart[itemKey].quantity + delta);
            cart[itemKey].additives = {...selectedAdditives};
            if (cart[itemKey].quantity === 0) delete cart[itemKey]; // удаляем нулевые позиции
            updateCart();
            updateItemUI(itemKey);
        }

        function updateItemUI(itemKey) {
            const counter = document.getElementById('detail-counter');
            if (!counter || counter.getAttribute('data-key') !== itemKey) return;
            const qty = counter.querySelector('.qty');
            const minus = counter.querySelector('.minus');
            const quantity = cart[itemKey] ? cart[itemKey].quantity : 0;
            qty.textContent = quantity;
            minus.style.display = quantity > 0 ? 'inline-block' : 'none';
        }

        /* CART button handling */
        const cartBtn = document.getElementById('cart-btn');
        const cartSumEl = document.getElementById('cart-sum');

        function formatPrice(v){ return `${v} р`; }

        function updateCart() {
            let total = 0;
            for (let key in cart) {
                let [cat, idx] = key.split(':');
                let item = menuData[cat][parseInt(idx)];
                let itemTotal = item.price * cart[key].quantity;
                for (let addKey in cart[key].additives) itemTotal += additives[addKey].price * cart[key].additives[addKey] * cart[key].quantity;
                total += itemTotal;
            }

            // update floating cart button
            cartSumEl.textContent = formatPrice(total);
            if (total > 0) {
                cartBtn.style.display = 'flex';
            } else {
                // hide cart when empty but keep small dot? we hide per request
                cartBtn.style.display = 'none';
            }

            // Telegram MainButton (if used)
            if (window.Telegram && Telegram.WebApp) {
                if (total > 0) {
                    Telegram.WebApp.MainButton.setText(`🛒 ${total} р`);
                    Telegram.WebApp.MainButton.show();
                } else Telegram.WebApp.MainButton.hide();
            }
        }

        // when clicking cart button show simple summary (can be replaced by modal)
        cartBtn.addEventListener('click', () => {
            const keys = Object.keys(cart);
            if (!keys.length) {
                alert('Корзина пуста');
                return;
            }
            let msg = 'Содержимое корзины:\n\n';
            let total = 0;
            keys.forEach(k => {
                const [cat, idx] = k.split(':');
                const item = menuData[cat][parseInt(idx)];
                const qty = cart[k].quantity;
                let itemTotal = item.price * qty;
                let adds = [];
                for (let a in cart[k].additives) {
                    adds.push(`${additives[a].name}`);
                    itemTotal += additives[a].price * cart[k].additives[a] * qty;
                }
                total += itemTotal;
                msg += `${item.name} × ${qty} — ${itemTotal} р` + (adds.length ? `\n  + ${adds.join(', ')}\n` : '\n');
            });
            msg += `\nИтого: ${total} р`;
            alert(msg);
        });

        function searchMenu(value) {
            value = value.toLowerCase();
            document.querySelectorAll('.item').forEach(item => {
                item.style.display = item.getAttribute('data-name').includes(value) ? 'block' : 'none';
            });
        }

        // handlers
        document.getElementById('close-btn').onclick = hideDetails;
        document.querySelector('#detail-counter .minus').onclick = () => changeQuantity(currentKey, -1);
        document.querySelector('#detail-counter .plus').onclick = () => changeQuantity(currentKey, 1);

        sheetOverlay.addEventListener('click', (e) => { if (e.target === sheetOverlay) hideDetails(); });
        details.addEventListener('click', (e) => e.stopPropagation());

        // init UI
        renderTabs();
        renderMenu();

        // Telegram WebApp integration (safe)
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.MainButton.setParams({color: '#27AE60', text_color: '#ffffff'});
            Telegram.WebApp.MainButton.onClick(() => {
                Telegram.WebApp.sendData(JSON.stringify(cart));
                Telegram.WebApp.close();
            });
            Telegram.WebApp.expand();
        }

        /* === ADDRESS MODAL: logic for open/select/add addresses === */
        (function(){
          const modal = document.getElementById('address-modal');
          const modalOverlay = modal.querySelector('.modal-overlay');
          const modalClose = modal.querySelector('.modal-close');
          const list = document.getElementById('address-list');
          const saveBtn = document.getElementById('save-address');
          const input = document.getElementById('new-address');
          const addrLine = document.getElementById('addr-line');
          const addrSub = document.getElementById('addr-sub');
          const addrIndicator = document.getElementById('addr-indicator');

          const openModal = () => {
              modal.classList.add('active');
              modal.setAttribute('aria-hidden','false');
              renderAddresses();
              setTimeout(()=>input.focus(),100);
          };
          const closeModal = () => {
              modal.classList.remove('active');
              modal.setAttribute('aria-hidden','true');
          };

          function getAddresses() {
              return JSON.parse(localStorage.getItem('addresses') || '[]');
          }

          function renderAddresses() {
            const addresses = getAddresses();
            list.innerHTML = '';
            if (!addresses.length) {
              list.innerHTML = '<div style="color:#777;text-align:center;">Нет сохранённых адресов</div>';
              return;
            }
            const selected = localStorage.getItem('selectedAddress') || null;
            addresses.forEach(a => {
              const div = document.createElement('div');
              div.className = 'address-item';
              div.innerHTML = `<div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${a}</div>`;
              if (selected === a) div.classList.add('selected');
              div.onclick = () => {
                localStorage.setItem('selectedAddress', a);
                addrLine.textContent = a;
                addrSub.textContent = 'Санкт-Петербург, Россия';
                addrIndicator.classList.add('selected');
                closeModal();
              };
              list.appendChild(div);
            });
          }

          function addAddress() {
            const value = input.value.trim();
            if (!value) return;
            const addresses = getAddresses();
            addresses.unshift(value); // добавляем в начало
            localStorage.setItem('addresses', JSON.stringify(addresses));
            localStorage.setItem('selectedAddress', value);
            addrLine.textContent = value;
            addrSub.textContent = 'Санкт-Петербург, Россия';
            addrIndicator.classList.add('selected');
            input.value = '';
            renderAddresses();
            closeModal();
          }

          // wire events
          document.getElementById('main-address').addEventListener('click', openModal);
          document.getElementById('add-address-top').addEventListener('click', openModal);
          modalOverlay.addEventListener('click', closeModal);
          modalClose.addEventListener('click', closeModal);
          saveBtn.addEventListener('click', addAddress);
          input.addEventListener('keydown', (e) => { if (e.key === 'Enter') addAddress(); });

          // load last selected
          const saved = localStorage.getItem('selectedAddress');
          if (saved) {
            addrLine.textContent = saved;
            addrIndicator.classList.add('selected');
          }

          // Hide cart button initially if empty
          updateCart();
        })();
    </script>
</body>
</html>
